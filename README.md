# Project

This is the Starter Kit repo for Management Control Plane project.

This repo has seven folders as explained briefly here. A more detailed readme.md could be found in some individual folders when more detailed information is expected.

## docs

This folder contains a blog item that explains why and how we implemented the dashboard solution for management control plane. 
## managed-app-deployment-scripts

This folder contains all necessary configuration and set up scripts for Scale Unit definition. 

### prerequiste

    - Create a new storage account name. The POC used "poccontrolplanetf", since storage account needs to be globally unique, you need to change it to a name of your choosing - poccontrolplanexx. 
    - Update subscription id and storage account name in the .json and .sh files in this managed-app-deployment-scripts folder
    - Run ./refresh-zipfiles.sh to refresh the managedScaleUnit.zip
    - Create a "ControlPlaneSP' service principal using the following command
    - Create a "CSE Viper" User group and your id and any id that you wish to have access to the resource group to the user group. The name of the user group can be changed to anything. But if you change it, you need to change it in create-managed-app-definition.sh to match. 
  
```bash

az ad sp create-for-rbac -n ControlPlaneSP --role Contributor --scopes /subscriptions/${yourSubscriptionId}

```
    - Create the "ControlPlanePOC" resource group. You can create this resource group by either running the pipeline "provision-control-plane.yml" or run the terraform scripts in "terraform-control-plane" folder

   The ControlPlanePOC resource group will contain the following resources:

    - storage account ("poccontrolplanexx") with public blob access. You need to create the following containers with public access

        1. blob-function-zip (Blob). You will upload /sample/blob-function-1.0-2023-05-04T23_45_13.767Z.zip here. 
        2. deployment-tf (container). You will upload /terraform-managed-application/application-scale-unit.zip here.
        3. managedapp (container). You will upload /managed-app-deployment-scripts/managedScaleUnit.zip here. 
        4. tfstate (Blob). This is generated by pipeline to store the tfstate. It's not needed by scale unit deployment

    - log analytics workspace (laws-control-plan). This is the unified sink for all resources provisioned in scale units
    - azure managed grafana. You can import dashboard templates here and update subscription and log analytics workspace resource id to get the boards to display. 
  
   Once the ControlPlanePOC resource group is created, create a user managed identity "deployment_controller" and grant "Contributor" role to the subscription. This is the identity being used to create scale units later.

   Grant "appliance resource provider" contributor role to the ControlPlanePOC resource group in azure portal. 

## managed-app-operation-scripts

Sample scripts to execute to perform custom action on the scale unit.

You need to use "az login" to log in and set the subscription first.

We didn't implement any life cycle scripts. This is just an illustration to demo the capability.

## monitoring

This folder contains the top level and scale unit level dashboard view template json file.

The "scripts" folder underneath contains sample scripts that can be run from commandline to check scale unit health.

"scenario-based" subfolder contains dashboard template that uses custom instrumentation created by Open Telemetary API.

## pipelines

This folder contains ADO pipeline yaml files and scripts that's used to create the infrastructure necessary for the control plane.

## sample

This is the folder that contains the data generator and the zip file for azure function deployment. 

dataGenetor folder contains the java program that will generate random traffic to event hubs configured in config.json. You can create config.json by running /monitoring/scripts/creaetConfigJson.sh once you use ' az login --service-principal --username [CotrolPlaneSP id] --password  [ControlPlanSP password] --tenant [tenant id]' to log into the resource group.

upload the blob-functionxxx.zip to the blob-function-zip folder under storage account in ControlPlanePOC before running scripts to create a scale unit.
## terraform-control-plane

Terraform code that can be triggered in pipeline to provision azure resources for the management control plane. Resource modules include creating the resource group, the log analytics workspace and azure managed grafana.

## terraform-managed-application

Terraform code that deploys the resource and application as defined in managed-scale-unit in azure folder. This is the code that gets invoked when user deploys a new scale unit. It will create an event hub, an azure function, and storage account for each scale unit. It will configure these components to export metrics information to log analytics workspace created ahead of time to allow grafana access to create the dashboard.

application-scale-unit.zip is provided so you can upload to ControlPlanePOC resource group directly without running the pipeline.


__NOTE__ If you have any question, please feel free to contact Yang Song [mailto:songy@microsoft.com].